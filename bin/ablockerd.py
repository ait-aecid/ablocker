#!/usr/bin/env python3
""" Anomaly Blocking Service

This daemon exports data from a kafka topic and watches
for anomalies generated by logdata-anomaly-miner. If an
anomaly occurs it triggers an actions.
"""

import sys

import os
import socket
import configparser
import logging
import logging.config
import argparse
import signal

sys.path = sys.path[1:]+['/usr/lib/ablocker']
from metadata import __version_string__, __version__  # skipcq: FLK-E402
from ablocker import Ablocker # skipcq: FLK-E402
import ast

CONFIGFILE = '/etc/aminer/kafka.conf'
ak = None


def exitgracefully(signum, frame):
    """ Make sure that the ablocker-state
        will be saved.
    """
    global ak
    ak.close()
    sys.exit(0)

def read_config():
    global CONFIGFILE
    options = dict()
    kafka_options = dict()
    # GENERAL section allows to use DEFAULT without being
    # added automatically to all the other sections.
    config = configparser.ConfigParser(default_section="GENERAL")
    try:
        config.read(CONFIGFILE)
        options = dict(config.items("DEFAULT"))
        kafka_options = dict(config.items("KAFKA"))
    except:
        options['topics'] = "['aminer']"
        kafka_options['bootstrap_servers'] = "localhost:9092"

    if 'KAFKA_TOPICS' in os.environ:
        options['topics'] = os.environ.get('KAFKA_TOPICS')

    if 'KAFKA_BOOTSTRAP_SERVERS' in os.environ:
        kafka_options['bootstrap_servers'] = os.environ.get('KAFKA_BOOTSTRAP_SERVERS')

    if 'ABLOCKER_SEARCH' in os.environ:
        options['search'] = os.environ.get('ABLOCKER_SEARCH')

    if 'ABLOCKER_FILTERS' in os.environ:
        options['filters'] = os.environ.get('ABLOCKER_FILTERS')


    return options,kafka_options


def main():
    global ak
    global CONFIGFILE
    description="A daemon that polls anomalies from kafka-topics and triggers actions"

    parser = argparse.ArgumentParser(description=description)
    parser.add_argument('-v', '--version', action='version', version=__version_string__)
    args = parser.parse_args()

    options,kafka_options = read_config()
    logger = False

    try:
        logging.config.fileConfig(CONFIGFILE)
    except KeyError:
        logging.basicConfig(level=logging.DEBUG)

    logger = logging.getLogger()

    for key, val in kafka_options.items():
        try:
            kafka_options[key] = int(val)
        except:
            pass

    topics = ast.literal_eval(options.get('topics'))

    logger.info("starting ablocker daemon...")
    ak = Ablocker(*topics,**kafka_options)

    if options.get('search'):
        ak.searchlist = ast.literal_eval(options.get('search'))
    if options.get('filters'):
        ak.setfilter(options.get('filters'))
    if options.get('source_key'):
        ak.set_source_key(options.get('source_key'))
    if options.get('source_key'):
        ak.exec_script = options.get('exec_script')

    try:
        while True:
            logger.debug("Watching for anomalies..")
            ak.run()
    except KeyboardInterrupt:
        ak.close()

if __name__=='__main__':
    signal.signal(signal.SIGINT, exitgracefully)
    signal.signal(signal.SIGTERM, exitgracefully)
    signal.signal(signal.SIGUSR1, exitgracefully)
    main()


